<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArcShopper</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0c0c0c;
      --surface: #161616;
      --surface-2: #1e1e1e;
      --border: #2a2a2a;
      --text: #fafafa;
      --text-2: #ccc;
      --text-3: #999;
      --accent: #fff;
      --success: #4ade80;
      --success-dim: rgba(74, 222, 128, 0.1);
    }

    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Subtle grain texture */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: 0;
    }

    /* Header */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: 20px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(12, 12, 12, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-mark svg {
      width: 28px;
      height: 28px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .wallet-menu {
      position: relative;
    }

    .balance-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .balance-pill:hover {
      border-color: var(--text-3);
    }

    .balance-pill .amount {
      color: var(--success);
      font-family: 'DM Mono', monospace;
    }

    .wallet-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 280px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s;
      z-index: 100;
    }

    .wallet-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .wallet-dropdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .refresh-btn {
      padding: 6px;
      background: transparent;
      border: none;
      color: var(--text-2);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .refresh-btn:hover {
      color: var(--text);
      background: var(--surface-2);
    }

    .refresh-btn.spinning i {
      animation: spin 0.8s linear infinite;
    }

    .wallet-address-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--surface-2);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .wallet-address {
      font-family: 'DM Mono', monospace;
      font-size: 14px;
    }

    .copy-btn {
      padding: 6px;
      background: transparent;
      border: none;
      color: var(--text-2);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .copy-btn:hover {
      color: var(--text);
      background: var(--surface);
    }

    .wallet-full-address {
      padding: 10px;
      background: var(--surface-2);
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .wallet-full-address code {
      font-size: 11px;
      color: var(--text-2);
      word-break: break-all;
    }

    .fund-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      color: var(--success);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      border-radius: 10px;
      transition: all 0.2s;
    }

    .fund-link:hover {
      background: var(--success-dim);
    }

    .signout-link {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px;
      background: transparent;
      border: none;
      color: var(--text-2);
      font-size: 14px;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.2s;
    }

    .signout-link:hover {
      background: var(--surface-2);
      color: var(--text);
    }

    .avatar-btn {
      width: 36px;
      height: 36px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-2);
      transition: all 0.2s;
    }

    .avatar-btn:hover {
      border-color: var(--text-2);
      color: var(--text);
    }

    .sign-in-btn {
      padding: 10px 20px;
      background: var(--text);
      border: none;
      border-radius: 100px;
      color: var(--bg);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sign-in-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* Main */
    main {
      position: relative;
      z-index: 1;
      max-width: 600px;
      margin: 0 auto;
      padding: 140px 24px 80px;
      min-height: 100vh;
    }

    /* Hero */
    .hero {
      text-align: center;
      margin-bottom: 48px;
    }

    .hero h1 {
      font-size: 48px;
      font-weight: 600;
      letter-spacing: -2px;
      margin-bottom: 12px;
      background: linear-gradient(180deg, #fff 0%, #888 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .hero p {
      font-size: 16px;
      color: var(--text-2);
      max-width: 400px;
      margin: 0 auto;
    }

    /* Search */
    .search-container {
      margin-bottom: 24px;
    }

    .search-box {
      display: flex;
      gap: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 8px;
      transition: all 0.2s;
    }

    .search-box:focus-within {
      border-color: var(--text-3);
      box-shadow: 0 0 0 4px rgba(255,255,255,0.05);
    }

    .search-input {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 16px;
      font-family: inherit;
    }

    .search-input:focus { outline: none; }
    .search-input::placeholder { color: var(--text-3); }

    .search-btn {
      padding: 12px 24px;
      background: var(--text);
      border: none;
      border-radius: 10px;
      color: var(--bg);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .search-btn:hover { opacity: 0.9; }
    .search-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .search-btn i { width: 18px; height: 18px; }

    /* Quick picks */
    .quick-picks {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .quick-pick {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 100px;
      color: var(--text-2);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-pick:hover {
      border-color: var(--text-2);
      color: var(--text);
    }

    /* Results */
    .results {
      margin-top: 40px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      background: var(--surface);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      color: var(--text-3);
    }

    .empty-state p {
      color: var(--text-3);
      font-size: 14px;
    }

    /* Result card */
    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-header {
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid var(--border);
    }

    .result-icon {
      width: 48px;
      height: 48px;
      background: var(--success-dim);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--success);
    }

    .result-title {
      flex: 1;
    }

    .result-title h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .result-title p {
      font-size: 13px;
      color: var(--text-2);
    }

    .result-status {
      padding: 6px 12px;
      background: var(--success-dim);
      border-radius: 100px;
      font-size: 12px;
      font-weight: 600;
      color: var(--success);
    }

    .result-body {
      padding: 24px;
    }

    /* Product in result */
    .product-row {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--surface-2);
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .product-emoji {
      font-size: 32px;
    }

    .product-info { flex: 1; }

    .product-name {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .product-desc {
      font-size: 13px;
      color: var(--text-2);
    }

    .product-price {
      font-size: 24px;
      font-weight: 600;
      color: var(--success);
      font-family: 'DM Mono', monospace;
    }

    /* Content unlocked */
    .content-unlocked {
      background: var(--success-dim);
      border: 1px solid rgba(74, 222, 128, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .content-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-weight: 600;
      color: var(--success);
    }

    .content-header i { width: 18px; height: 18px; }

    .content-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 14px;
      color: var(--text);
    }

    .content-item i {
      width: 14px;
      height: 14px;
      color: var(--success);
    }

    .content-key {
      margin-top: 12px;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      word-break: break-all;
      color: var(--text-2);
    }

    /* Details toggle */
    .details-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-2);
      font-size: 13px;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
    }

    .details-toggle:hover {
      border-color: var(--text-3);
      color: var(--text);
    }

    .details-toggle i { width: 16px; height: 16px; }

    .details-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .details-content.open {
      max-height: 400px;
      margin-top: 16px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    .detail-row:last-child { border-bottom: none; }

    .detail-label { color: var(--text-2); }

    .detail-value {
      font-family: 'DM Mono', monospace;
      color: var(--text);
    }

    .detail-value a {
      color: var(--success);
      text-decoration: none;
    }

    .detail-value a:hover { text-decoration: underline; }

    /* Processing state */
    .processing {
      text-align: center;
      padding: 48px 24px;
    }

    .processing-spinner {
      width: 48px;
      height: 48px;
      border: 2px solid var(--border);
      border-top-color: var(--text);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .processing-text {
      font-size: 14px;
      color: var(--text-2);
    }

    .processing-step {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-3);
    }

    /* History */
    .history-section {
      margin-top: 48px;
      padding-top: 32px;
      border-top: 1px solid var(--border);
    }

    .history-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--surface);
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .history-item i {
      width: 16px;
      height: 16px;
      color: var(--success);
    }

    .history-name {
      flex: 1;
      font-size: 14px;
    }

    .history-amount {
      font-family: 'DM Mono', monospace;
      font-size: 14px;
      color: var(--success);
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-header {
      padding: 24px 24px 0;
      text-align: center;
    }

    .modal-header h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .modal-header p {
      font-size: 14px;
      color: var(--text-2);
    }

    .modal-body {
      padding: 24px;
    }

    .input-field {
      margin-bottom: 16px;
    }

    .input-field label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-2);
      margin-bottom: 8px;
    }

    .input-field input {
      width: 100%;
      padding: 14px 16px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 16px;
      font-family: inherit;
    }

    .input-field input:focus {
      outline: none;
      border-color: var(--text-2);
    }

    .modal-btn {
      width: 100%;
      padding: 16px;
      background: var(--text);
      border: none;
      border-radius: 12px;
      color: var(--bg);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn:hover { opacity: 0.9; }
    .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .modal-footer {
      text-align: center;
      padding: 0 24px 24px;
      font-size: 12px;
      color: var(--text-3);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 12px 20px;
      border-radius: 100px;
      font-size: 14px;
      z-index: 1001;
      animation: toastIn 0.3s ease;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateX(-50%) translateY(10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* Fund wallet CTA */
    .fund-cta {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-top: 16px;
    }

    .fund-cta-icon {
      width: 40px;
      height: 40px;
      background: var(--surface);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-2);
    }

    .fund-cta-text {
      flex: 1;
    }

    .fund-cta-text strong {
      display: block;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .fund-cta-text span {
      font-size: 12px;
      color: var(--text-2);
    }

    .fund-cta-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .fund-cta-btn:hover {
      border-color: var(--text-2);
    }

    /* Responsive */
    @media (max-width: 640px) {
      header { padding: 16px 20px; }
      main { padding: 120px 20px 60px; }
      .hero h1 { font-size: 36px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-mark">
        <svg viewBox="0 0 32 32">
          <path d="M6 8 L10 8 L14 22 L26 22" fill="none" stroke="#4ade80" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 12 L28 12 L26 22 L14 22" fill="none" stroke="#fff" stroke-width="2" stroke-linejoin="round"/>
          <circle cx="16" cy="27" r="2" fill="#4ade80"/>
          <circle cx="24" cy="27" r="2" fill="#4ade80"/>
        </svg>
      </div>
      <span>ArcShopper</span>
    </div>
    <div class="header-right" id="header-right">
      <button class="sign-in-btn" onclick="showSignIn()">Sign in</button>
    </div>
  </header>

  <main>
    <div class="hero">
      <h1>Buy anything</h1>
      <p>Your AI agent handles all your commerce needs.</p>
      <p style="font-size: 11px; color: var(--text-3); margin-top: 12px;">Demo on Arc Testnet. Not financial advice.</p>
    </div>

    <div class="search-container">
      <div class="search-box">
        <input
          type="text"
          class="search-input"
          id="query"
          placeholder="e.g. API credits, security report..."
        />
        <button class="search-btn" id="buy-btn" onclick="buy()">
          <i data-lucide="sparkles"></i>
          Buy
        </button>
      </div>
    </div>

    <div class="quick-picks">
      <button class="quick-pick" data-product="crypto-api">Crypto API Access</button>
      <button class="quick-pick" data-product="premium-image">Premium Image</button>
      <button class="quick-pick" data-product="trend-report">Trend Report</button>
      <button class="quick-pick" data-product="arc-course">Arc Crash Course</button>
    </div>

    <div class="results" id="results">
      <div class="empty-state">
        <div class="empty-icon"><i data-lucide="package"></i></div>
        <p>Search for something to get started</p>
      </div>
    </div>

    <div class="history-section" id="history-section" style="display: none;">
      <div class="history-title">Recent Purchases</div>
      <div id="history-list"></div>
    </div>
  </main>

  <!-- Sign In Modal -->
  <div class="modal-overlay" id="signin-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Welcome</h2>
        <p>Enter your email to get started</p>
      </div>
      <div class="modal-body">
        <div class="input-field">
          <label>Email</label>
          <input type="email" id="email-input" placeholder="you@example.com" />
        </div>
        <button class="modal-btn" id="signin-submit" onclick="signIn()">Continue</button>
      </div>
      <div class="modal-footer">
        A wallet will be created for you automatically
      </div>
    </div>
  </div>

  <script>
    const API = '/api';
    const EXPLORER = 'https://testnet.arcscan.app';

    let isSignedIn = false;
    let userEmail = null;
    let walletAddress = null;
    let walletBalance = '0';

    lucide.createIcons();

    // UI Functions
    function showSignIn() {
      document.getElementById('signin-modal').classList.add('active');
      document.getElementById('email-input').focus();
    }

    function hideSignIn() {
      document.getElementById('signin-modal').classList.remove('active');
    }

    function showToast(msg) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function updateHeader() {
      const headerRight = document.getElementById('header-right');

      if (isSignedIn && userEmail) {
        headerRight.innerHTML = `
          <div class="wallet-menu">
            <button class="balance-pill" onclick="toggleWalletMenu()">
              <span class="amount">$${parseFloat(walletBalance).toFixed(2)}</span>
              <span style="color: var(--text-3)">USDC</span>
              <i data-lucide="chevron-down" style="width:14px;height:14px;margin-left:4px;color:var(--text-3)"></i>
            </button>
            <div class="wallet-dropdown" id="wallet-dropdown">
              <div class="wallet-dropdown-header">
                <span style="color:var(--text-2);font-size:12px;">Your Wallet</span>
                <button class="refresh-btn" onclick="refreshBalance(event)" title="Refresh balance">
                  <i data-lucide="refresh-cw" style="width:14px;height:14px"></i>
                </button>
              </div>
              <div class="wallet-address-row">
                <span class="wallet-address">${walletAddress.slice(0,6)}...${walletAddress.slice(-4)}</span>
                <button class="copy-btn" onclick="copyAddress(event)">
                  <i data-lucide="copy" style="width:14px;height:14px"></i>
                </button>
              </div>
              <div class="wallet-full-address" id="full-address" style="display:none;">
                <code>${walletAddress}</code>
              </div>
              <a href="https://faucet.circle.com" target="_blank" class="fund-link">
                <i data-lucide="plus-circle" style="width:16px;height:16px"></i>
                Get testnet USDC
              </a>
              <button class="signout-link" onclick="signOut()">
                <i data-lucide="log-out" style="width:16px;height:16px"></i>
                Sign out
              </button>
            </div>
          </div>
        `;
      } else {
        headerRight.innerHTML = `
          <button class="sign-in-btn" onclick="showSignIn()">Sign in</button>
        `;
      }
      lucide.createIcons();
    }

    function toggleWalletMenu() {
      const dropdown = document.getElementById('wallet-dropdown');
      dropdown.classList.toggle('open');
    }

    function copyAddress(e) {
      e.stopPropagation();
      navigator.clipboard.writeText(walletAddress);
      showToast('Address copied!');
      // Show full address briefly
      const full = document.getElementById('full-address');
      full.style.display = 'block';
      setTimeout(() => full.style.display = 'none', 3000);
    }

    async function refreshBalance(e) {
      e.stopPropagation();
      e.preventDefault();
      const btn = e.currentTarget;
      btn.classList.add('spinning');

      try {
        if (!walletAddress) {
          showToast('No wallet connected');
          return;
        }

        // Use simple balance endpoint (no Circle API needed)
        const res = await fetch(API + '/balance/' + walletAddress);
        const data = await res.json();

        if (data.success) {
          walletBalance = data.balance?.usdc || '0';

          // Update balance display directly
          const amountEl = document.querySelector('.wallet-btn .amount');
          if (amountEl) {
            amountEl.textContent = '$' + parseFloat(walletBalance).toFixed(2);
          }

          showToast('Balance: $' + parseFloat(walletBalance).toFixed(2));
        } else {
          showToast('Failed to refresh');
        }
      } catch (err) {
        console.error('Refresh error:', err);
        showToast('Failed to refresh');
      } finally {
        btn.classList.remove('spinning');
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('wallet-dropdown');
      if (dropdown && !e.target.closest('.wallet-menu')) {
        dropdown.classList.remove('open');
      }
    });

    // Auth Functions
    async function signIn() {
      const email = document.getElementById('email-input').value.trim();
      if (!email || !email.includes('@')) {
        showToast('Please enter a valid email');
        return;
      }

      const btn = document.getElementById('signin-submit');
      btn.disabled = true;
      btn.textContent = 'Creating wallet...';

      try {
        const res = await fetch(API + '/circle/wallet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: email })
        });
        const data = await res.json();

        if (data.walletAddress) {
          userEmail = email;
          walletAddress = data.walletAddress;
          walletBalance = data.balance?.usdc || '0';
          isSignedIn = true;

          localStorage.setItem('arc_email', email);
          localStorage.setItem('arc_wallet', walletAddress);

          hideSignIn();
          updateHeader();
          loadHistory();
          showToast('Welcome to ArcShopper');
        } else {
          throw new Error(data.error || 'Failed to create wallet');
        }
      } catch (e) {
        showToast('Error: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Continue';
      }
    }

    function signOut() {
      isSignedIn = false;
      userEmail = null;
      walletAddress = null;
      walletBalance = '0';
      localStorage.removeItem('arc_email');
      localStorage.removeItem('arc_wallet');
      updateHeader();
      document.getElementById('history-section').style.display = 'none';
      showToast('Signed out');
    }

    // Balance
    async function loadBalance() {
      if (!userEmail) return;
      try {
        const res = await fetch(API + '/circle/wallet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: userEmail })
        });
        const data = await res.json();
        walletBalance = data.balance?.usdc || '0';
        walletAddress = data.walletAddress || walletAddress;
        updateHeader();
      } catch (e) {
        console.error('Balance error:', e);
      }
    }

    // History - uses shop orders endpoint
    async function loadHistory() {
      if (!isSignedIn) return;
      try {
        const res = await fetch(API + '/shop/orders');
        const data = await res.json();

        if (data.orders?.length) {
          document.getElementById('history-section').style.display = 'block';
          document.getElementById('history-list').innerHTML = data.orders.slice(-5).reverse().map(o => `
            <div class="history-item">
              <i data-lucide="check-circle"></i>
              <span class="history-name">${o.items?.[0]?.name || 'Order'}</span>
              <span class="history-amount">${o.totalAmount}</span>
            </div>
          `).join('');
          lucide.createIcons();
        }
      } catch (e) {
        console.error('History error:', e);
      }
    }

    // Product mapping - must match actual marketplace product names
    const PRODUCTS = {
      'crypto-api': { name: 'CoinGecko API Access', emoji: 'üîë', price: 0.99 },
      'premium-image': { name: 'Premium Stock Image', emoji: 'üñºÔ∏è', price: 0.50 },
      'trend-report': { name: 'Crypto Trend Report', emoji: 'üìä', price: 1.99 },
      'arc-course': { name: 'Arc Blockchain Course', emoji: 'üìö', price: 2.99 }
    };

    // Main buy function
    async function buy() {
      if (!isSignedIn) {
        showSignIn();
        return;
      }

      const query = document.getElementById('query').value.trim();
      const btn = document.getElementById('buy-btn');
      const results = document.getElementById('results');

      if (!query) return;

      // Show processing
      btn.disabled = true;
      results.innerHTML = `
        <div class="result-card">
          <div class="processing">
            <div class="processing-spinner"></div>
            <div class="processing-text">Processing your order</div>
            <div class="processing-step" id="step-text">Finding products...</div>
          </div>
        </div>
      `;

      try {
        document.getElementById('step-text').textContent = 'Processing purchase...';

        const res = await fetch(API + '/x402/buy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: 'Buy ' + query, userId: userEmail })
        });
        const data = await res.json();

        if (data.success && data.order) {
          displaySuccess(data);
          loadBalance();
        } else if (!data.approved) {
          throw new Error(data.message || 'Purchase not approved');
        } else {
          throw new Error(data.error || data.message || 'Purchase failed');
        }
      } catch (e) {
        results.innerHTML = `
          <div class="result-card">
            <div class="result-body" style="text-align: center; padding: 32px;">
              <div style="color: #f87171; margin-bottom: 12px;">
                <i data-lucide="alert-circle" style="width: 32px; height: 32px;"></i>
              </div>
              <p style="color: var(--text); margin-bottom: 8px;">Something went wrong</p>
              <p style="color: var(--text-2); font-size: 13px;">${e.message}</p>
              ${e.message.toLowerCase().includes('insufficient') || e.message.toLowerCase().includes('balance') ? `
                <div class="fund-cta">
                  <div class="fund-cta-icon"><i data-lucide="wallet"></i></div>
                  <div class="fund-cta-text">
                    <strong>Need funds?</strong>
                    <span>Get testnet USDC to continue</span>
                  </div>
                  <a href="https://faucet.circle.com" target="_blank" class="fund-cta-btn">Get USDC</a>
                </div>
              ` : ''}
            </div>
          </div>
        `;
        lucide.createIcons();
      } finally {
        btn.disabled = false;
      }
    }

    function quickBuy(productId) {
      document.getElementById('query').value = PRODUCTS[productId]?.name || productId;
      buy();
    }

    function displaySuccess(data) {
      const results = document.getElementById('results');
      const product = data.selectedProduct;
      const order = data.order;
      const txHash = order.txHash; // No fake - require real tx

      if (!txHash) {
        // No real transaction - show error
        results.innerHTML = `
          <div class="result-card" style="border-color: #f87171;">
            <div class="result-header">
              <div class="result-icon" style="background: rgba(248, 113, 113, 0.1);"><i data-lucide="alert-triangle" style="color: #f87171;"></i></div>
              <div class="result-title">
                <h3 style="color: #f87171;">Payment Not Executed</h3>
                <p>No blockchain transaction was made</p>
              </div>
            </div>
            <div class="result-body">
              <p style="color: var(--text-2);">The x402 payment failed to execute on-chain. Check server logs for details.</p>
            </div>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      results.innerHTML = `
        <div class="result-card">
          <div class="result-header">
            <div class="result-icon"><i data-lucide="check"></i></div>
            <div class="result-title">
              <h3>Purchase Complete</h3>
              <p>${data.message || 'Your order is confirmed on-chain'}</p>
            </div>
            <div class="result-status">Confirmed</div>
          </div>
          <div class="result-body">
            <div class="product-row">
              <span class="product-emoji">${EMOJIS[product?.category] || 'üì¶'}</span>
              <div class="product-info">
                <div class="product-name">${product?.name || 'Product'}</div>
                <div class="product-desc">${product?.description || ''}</div>
              </div>
              <div class="product-price">${order.totalAmount}</div>
            </div>

            <div class="content-unlocked">
              <div class="content-header"><i data-lucide="check-circle"></i> Order Confirmed</div>
              <div class="content-item"><i data-lucide="hash"></i> Order #${order.id.slice(0, 8)}</div>
              <div class="content-item"><i data-lucide="credit-card"></i> Paid via ${order.paymentMethod || 'x402'}</div>
              <div class="content-item"><i data-lucide="clock"></i> ${new Date().toLocaleString()}</div>
            </div>

            <button class="details-toggle" onclick="toggleDetails(this)">
              <i data-lucide="receipt"></i>
              View transaction details
              <i data-lucide="chevron-down"></i>
            </button>

            <div class="details-content" id="tx-details">
              <div class="detail-row">
                <span class="detail-label">Transaction</span>
                <span class="detail-value"><a href="${EXPLORER}/tx/${txHash}" target="_blank">${txHash.slice(0, 10)}...${txHash.slice(-6)}</a></span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Network</span>
                <span class="detail-value">Arc Testnet</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Amount</span>
                <span class="detail-value">${order.totalAmount}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Method</span>
                <span class="detail-value">${order.paymentMethod || 'x402'}</span>
              </div>
            </div>
          </div>
        </div>
      `;
      lucide.createIcons();
    }

    // Emoji map for products
    const EMOJIS = {
      'api': 'üîë',
      'content': 'üñºÔ∏è',
      'courses': 'üìö',
      'report': 'üìä'
    };

    function toggleDetails(btn) {
      const content = document.getElementById('tx-details');
      const icon = btn.querySelector('[data-lucide="chevron-down"], [data-lucide="chevron-up"]');
      content.classList.toggle('open');
      icon.setAttribute('data-lucide', content.classList.contains('open') ? 'chevron-up' : 'chevron-down');
      lucide.createIcons();
    }

    // Quick picks - use actual product names from PRODUCTS mapping
    document.querySelectorAll('.quick-pick').forEach(btn => {
      btn.onclick = () => {
        const productId = btn.dataset.product;
        document.getElementById('query').value = PRODUCTS[productId]?.name || productId;
        buy();
      };
    });

    // Enter key
    document.getElementById('query').onkeypress = e => { if (e.key === 'Enter') buy(); };
    document.getElementById('email-input').onkeypress = e => { if (e.key === 'Enter') signIn(); };

    // Click outside modal
    document.getElementById('signin-modal').onclick = e => {
      if (e.target.id === 'signin-modal') hideSignIn();
    };

    // Restore session
    const savedEmail = localStorage.getItem('arc_email');
    const savedWallet = localStorage.getItem('arc_wallet');
    if (savedEmail && savedWallet) {
      userEmail = savedEmail;
      walletAddress = savedWallet;
      isSignedIn = true;
      loadBalance();
      loadHistory();
    }
    updateHeader();
  </script>
</body>
</html>
